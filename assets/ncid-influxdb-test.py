# Received: 200 Server: ncidd [zeroBlocker:3333] (NCID) 1.10
# Received: 210 API: 1.8 Feature Set 1 2 3 4 5
# Received: CIDLOG: *DATE*11292022*TIME*1717*LINE*POTS*NMBR*07940773737*MESG*NONE*NAME*Graham*
# Received: CIDLOG: *DATE*11302022*TIME*0829*LINE*POTS*NMBR*07940773737*MESG*NONE*NAME*Graham*
# Received: 250 End of call log
# Received: OPT: LineIDS: POTS
# Received: 300 End of connection startup

# Received: CID: *DATE*11302022*TIME*0829*LINE*POTS*NMBR*07940773737*MESG*NONE*NAME*Graham*
# Received: CIDINFO: *LINE*POTS*RING*1*TIME*08:29:48*
# Received: CIDINFO: *LINE*POTS*RING*0*TIME*08:29:55*
CIDLOG = [ {'DATE': '11022022', 'TIME': '1601', 'LINE': 'POTS', 'NMBR': '02922640074', 'MESG': 'NONE', 'NAME': 'NO NAME'},
{'DATE': '11022022', 'TIME': '1923', 'LINE': 'POTS', 'NMBR': '07486098621', 'MESG': 'NONE', 'NAME': 'Phoebe'} ,
{'DATE': '11022022', 'TIME': '1934', 'LINE': 'POTS', 'NMBR': '07486098621', 'MESG': 'NONE', 'NAME': 'Phoebe'} ,
{'DATE': '11022022', 'TIME': '1934', 'LINE': 'POTS', 'NMBR': '07486098621', 'MESG': 'NONE', 'NAME': 'Phoebe'} ,
{'DATE': '11042022', 'TIME': '1010', 'LINE': 'POTS', 'NMBR': '02080048584', 'MESG': 'NONE', 'NAME': 'NO NAME'},
{'DATE': '11042022', 'TIME': '2235', 'LINE': 'POTS', 'NMBR': '07486098621', 'MESG': 'NONE', 'NAME': 'Phoebe'} ,
{'DATE': '11052022', 'TIME': '1814', 'LINE': 'POTS', 'NMBR': '01483773763', 'MESG': 'NONE', 'NAME': 'Pat'}    ,
{'DATE': '11062022', 'TIME': '1452', 'LINE': 'POTS', 'NMBR': '01483773763', 'MESG': 'NONE', 'NAME': 'Pat'}    ,
{'DATE': '11062022', 'TIME': '1854', 'LINE': 'POTS', 'NMBR': '01483474732', 'MESG': 'NONE', 'NAME': 'Dad'}    ,
{'DATE': '11082022', 'TIME': '1851', 'LINE': 'POTS', 'NMBR': '01483474732', 'MESG': 'NONE', 'NAME': 'Dad'}    ,
{'DATE': '11092022', 'TIME': '1003', 'LINE': 'POTS', 'NMBR': '01273525818', 'MESG': 'NONE', 'NAME': 'NO NAME'},
{'DATE': '11092022', 'TIME': '1143', 'LINE': 'POTS', 'NMBR': '01273542313', 'MESG': 'NONE', 'NAME': 'NO NAME'},
{'DATE': '11092022', 'TIME': '1846', 'LINE': 'POTS', 'NMBR': '01483474732', 'MESG': 'NONE', 'NAME': 'Dad'},
{'DATE': '11102022', 'TIME': '1805', 'LINE': 'POTS', 'NMBR': '01273723896', 'MESG': 'NONE', 'NAME': 'NO NAME'},
{'DATE': '11112022', 'TIME': '1429', 'LINE': 'POTS', 'NMBR': '03333219790', 'MESG': 'NONE', 'NAME': 'NO NAME'},
{'DATE': '11112022', 'TIME': '1743', 'LINE': 'POTS', 'NMBR': '02039308523', 'MESG': 'NONE', 'NAME': 'NO NAME'},
{'DATE': '11122022', 'TIME': '0913', 'LINE': 'POTS', 'NMBR': '01483773763', 'MESG': 'NONE', 'NAME': 'Pat'},
{'DATE': '11122022', 'TIME': '1143', 'LINE': 'POTS', 'NMBR': '07486098621', 'MESG': 'NONE', 'NAME': 'Phoebe'},
{'DATE': '11122022', 'TIME': '1248', 'LINE': 'POTS', 'NMBR': '07486098621', 'MESG': 'NONE', 'NAME': 'Phoebe'},
{'DATE': '11132022', 'TIME': '0928', 'LINE': 'POTS', 'NMBR': '01483773763', 'MESG': 'NONE', 'NAME': 'Pat'},
{'DATE': '11142022', 'TIME': '1800', 'LINE': 'POTS', 'NMBR': '01483773763', 'MESG': 'NONE', 'NAME': 'Pat'},
{'DATE': '11152022', 'TIME': '1155', 'LINE': 'POTS', 'NMBR': '02922643789', 'MESG': 'NONE', 'NAME': 'NO NAME'},
{'DATE': '11152022', 'TIME': '1730', 'LINE': 'POTS', 'NMBR': '01273553371', 'MESG': 'NONE', 'NAME': 'Celia'},
{'DATE': '11152022', 'TIME': '1806', 'LINE': 'POTS', 'NMBR': '01483773763', 'MESG': 'NONE', 'NAME': 'Pat'},
{'DATE': '11162022', 'TIME': '1816', 'LINE': 'POTS', 'NMBR': '01483773763', 'MESG': 'NONE', 'NAME': 'Pat'},
{'DATE': '11172022', 'TIME': '1000', 'LINE': 'POTS', 'NMBR': '01268859762', 'MESG': 'NONE', 'NAME': 'NO NAME'},
{'DATE': '11222022', 'TIME': '1750', 'LINE': 'POTS', 'NMBR': '07486098621', 'MESG': 'NONE', 'NAME': 'Phoebe'},
{'DATE': '11222022', 'TIME': '1758', 'LINE': 'POTS', 'NMBR': '07486098621', 'MESG': 'NONE', 'NAME': 'Phoebe'},
{'DATE': '11232022', 'TIME': '1829', 'LINE': 'POTS', 'NMBR': '01483474732', 'MESG': 'NONE', 'NAME': 'Dad'},
{'DATE': '11242022', 'TIME': '1100', 'LINE': 'POTS', 'NMBR': '01134900983', 'MESG': 'NONE', 'NAME': 'NO NAME'},
{'DATE': '11252022', 'TIME': '0900', 'LINE': 'POTS', 'NMBR': '01483474732', 'MESG': 'NONE', 'NAME': 'Dad'},
{'DATE': '11282022', 'TIME': '1423', 'LINE': 'POTS', 'NMBR': '01252229781', 'MESG': 'NONE', 'NAME': 'NO NAME'},
{'DATE': '11282022', 'TIME': '1450', 'LINE': 'POTS', 'NMBR': '02922646938', 'MESG': 'NONE', 'NAME': 'NO NAME'},
{'DATE': '11292022', 'TIME': '1545', 'LINE': 'POTS', 'NMBR': '01923961297', 'MESG': 'NONE', 'NAME': 'NO NAME'},
{'DATE': '11292022', 'TIME': '1717', 'LINE': 'POTS', 'NMBR': '07940773737', 'MESG': 'NONE', 'NAME': 'Graham'},
{'DATE': '11302022', 'TIME': '0829', 'LINE': 'POTS', 'NMBR': '07940773737', 'MESG': 'NONE', 'NAME': 'Graham'} ]

from datetime import datetime
from influxdb_client import InfluxDBClient, Point, WritePrecision
from influxdb_client.client.write_api import SYNCHRONOUS
import asyncio
from colorama import just_fix_windows_console, Fore, Style
just_fix_windows_console()

token = "D0zKO08E2MzgkXeA241eeTHJsHZzUxRg8vvbVQMDSAzWenjpaFlB-sGsPeMamamMXHZIpsU-tqEkSD8sTsBSAg=="
org = "Home"
bucket = "Test"

def toPoint(items):
    t = datetime.strptime(items["DATE"] + " " + items["TIME"], "%m%d%Y %H%M")
    return Point('cid3').tag("LINE", "POTS").field("NAME", items["NAME"]).field('NMBR', items["NMBR"]).time(t)

def cid(text):
    items = text.split('*')
    keys = items[1::2]
    values = items[2::2]
    return dict(zip(keys,values))

def process(write_api, text):
    print(f'Received: {Fore.LIGHTBLUE_EX}{text}{Fore.RESET}')
    if "CIDLOG:" in text:
        print("CIDLOG:", cid(text))
        write_api.write(bucket, org, toPoint(cid(text)))

    if "CIDINFO:" in text:
        print("CIDINFO:", cid(text))

    if "CID:" in text:
        write_api.write(bucket, org, toPoint(cid(text)))
        print("CID:", cid(text))

    return "300 End" in text


async def ncid_client():
    reader, writer = await asyncio.open_connection('192.168.1.231', 3333)

    # print(f'Send: {message!r}')
    # writer.write(message.encode())
    # await writer.drain()

    try:
        with InfluxDBClient(url="http://192.168.1.224:8086", token=token, org=org) as client:
            write_api = client.write_api(write_options=SYNCHRONOUS)

            # for item in CIDLOG:
            #     write_api.write(bucket, org, toPoint(item))

            while True:
                data = await reader.readline()
                text = data.decode().strip()
                if process(write_api, text):
                    break;

    finally:
        print('Close the connection')
        write_api.close()
        writer.close()
        await writer.wait_closed()

asyncio.run(ncid_client())




# import asyncio, socket

# async def handle_client(client):
#     loop = asyncio.get_event_loop()
#     request = None
#     while request != 'quit':
#         request = (await loop.sock_recv(client, 255)).decode('utf8')
#         response = str(eval(request)) + '\n'
#         await loop.sock_sendall(client, response.encode('utf8'))
#     client.close()

# async def run_server():
#     server = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
#     server.bind(('192.168.1.231', 3333))
#     server.listen(8)
#     server.setblocking(False)

#     loop = asyncio.get_event_loop()

#     while True:
#         client, _ = await loop.sock_accept(server)
#         loop.create_task(handle_client(client))

# asyncio.run(run_server())





# import time
# from simple_socket.tcp_client import SimpleTCPClient # try also SimpleSSLClient for semi-secure communication (it does not verify the cert)

# client = SimpleTCPClient('192.168.1.231', 3333)
# print('client.Hostname=', client.Hostname)

# # by default, the client will connect and attempt to maintain its connection.
# # if you want to manually control the connection, pass autoConnect=False
# # then use the .Connect() and .Disconnect() methods to manage your connection manually

# client.onConnected = lambda _, state: print('The client is', state)
# client.onDisconnected = lambda _, state: print('The client is', state)

# client.onReceive = lambda _, data: print('Rx:', data.decode('utf8'))

# while True:
#     time.sleep(5)